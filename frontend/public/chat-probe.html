<!doctype html>
<meta charset="utf-8" />
<title>Chat Probe</title>
<style>
  body { font: 14px system-ui; padding: 16px; }
  input, button { font: inherit; }
  pre { white-space: pre-wrap; border: 1px solid #ccc; padding: 8px; border-radius: 6px; max-height: 60vh; overflow: auto; }
  .ok { color: #067d17; }
  .err { color: #b00020; }
</style>
<h1>Chat History Probe</h1>
<label>Backend base (leave empty to use Vite proxy): <input id="base" style="width: 420px" placeholder="http://localhost:8000"></label>
<br/><br/>
<label>Session ID: <input id="sid" type="number" value="1" style="width: 120px"></label>
<button id="go">Probe</button>
<pre id="out"></pre>
<script>
  const out = document.getElementById('out')
  function log(s, cls) {
    const div = document.createElement('div')
    if (cls) div.className = cls
    div.textContent = s
    out.appendChild(div)
  }
  function sep(){ out.appendChild(document.createElement('hr')) }

  async function fetchJson(url) {
    const res = await fetch(url, { credentials: 'include', headers: { 'Accept': 'application/json' } })
    const txt = await res.text()
    let body = txt
    try { body = JSON.parse(txt) } catch {}
    return { ok: res.ok, status: res.status, body }
  }

  document.getElementById('go').onclick = async () => {
    out.textContent = ''
    const base = (document.getElementById('base').value || '')
      .replace(/\/$/, '')
    const sid = document.getElementById('sid').value
    const urls = [
      `/chat/sessions/${sid}/messages`,
      `/chat/sessions/${sid}/messages/`,
      `/chat/sessions/${sid}/history`,
      `/chat/sessions/${sid}/history/`,
      `/chat/session/${sid}/messages`,
      `/chat/session/${sid}/messages/`,
      `/chat/session/${sid}/history`,
      `/chat/session/${sid}/history/`,
      `/chat/messages?session_id=${encodeURIComponent(String(sid))}`,
      `/chat/messages/?session_id=${encodeURIComponent(String(sid))}`,
    ]
    for (const u of urls) {
      const url = base ? (base + u) : u
      log('GET ' + url)
      try {
        const r = await fetchJson(url)
        log(`→ ${r.ok ? 'OK' : 'ERR'} ${r.status}`, r.ok ? 'ok' : 'err')
        log(typeof r.body === 'string' ? r.body : JSON.stringify(r.body, null, 2))
      } catch (e) {
        log('→ network error: ' + (e && e.message ? e.message : String(e)), 'err')
      }
      sep()
    }
  }
</script>
